name: Deploy Next.js to Namecheap Hosting

on:
  push:
    branches:
      - main  # This will trigger the pipeline when changes are pushed to the 'main' branch

jobs:
  deploy:
    runs-on: ubuntu-latest  # The workflow will run on an Ubuntu environment

    steps:
      # Step 1: Checkout the code from GitHub repository
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: Set up Node.js environment (replace with the version of Node.js you need)
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'  # You can replace '16' with the version of Node.js you use

      # Step 3: Install dependencies
      - name: Install dependencies
        run: npm install

      # Step 4: Build the Next.js app (optional, but good practice)
      - name: Build Next.js app
        run: npm run build

      # Step 5: Deploy to Namecheap server via SSH
      - name: Deploy to Namecheap via SSH
        env:
          PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}  # The private SSH key stored in GitHub secrets
          REMOTE_HOST: 66.29.132.45          # Replace with your Namecheap server IP or hostname
          REMOTE_USER: longczxa  # Replace with your SSH username (e.g., 'root' or 'username')
          REMOTE_PATH: /home/longczxa/thesoundwell-vibro-therapy-back.longevityproducts.info  # Update the path here
        run: |
          # Set up SSH key for deployment
          mkdir -p ~/.ssh
          echo "$PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # SSH into the server and deploy the application
          ssh -o StrictHostKeyChecking=no -p 22 $REMOTE_USER@$REMOTE_HOST << 'EOF'
            # Navigate to your app directory on the server
            cd $REMOTE_PATH || exit

            # Pull the latest changes from GitHub (assuming the repo is cloned on the server)
            git pull origin main || exit

            # Install production dependencies on the server
            npm install --production || exit

            # Build the Next.js app (optional, if already built locally)
            npm run build || exit

            # Restart the app with PM2 (or another process manager)
            pm2 restart next-app || exit
